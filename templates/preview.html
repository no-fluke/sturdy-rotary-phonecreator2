<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Builder - Upload</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 20px auto; padding: 20px; background: #f5f7fa; }
        .container { border: 2px dashed #2ec4b6; padding: 30px; text-align: center; background: white; border-radius: 10px; }
        #fileInput { margin: 20px 0; }
        #uploadBtn { padding: 10px 20px; background: #2ec4b6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; }
        #progress { display: none; margin-top: 20px; color: #2ec4b6; }
        h1 { color: #2ec4b6; }
        .quiz-type { margin: 20px 0; text-align: left; }
        .quiz-type label { margin-right: 20px; }
        .file-group { margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 5px; background: #f9f9f9; }
        .file-group input[type="text"] { width: 200px; padding: 5px; margin-right: 10px; }
        .remove-btn { background: #c82d3f; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
        #addSectionBtn { margin: 10px 0; background: #3498db; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>ðŸ“¤ Upload TXT / HTML File(s)</h1>
    <div class="container">
        <div class="quiz-type">
            <label><input type="radio" name="quiz_type" value="topic" checked onchange="toggleFullMock()"> Topic Wise (Single File)</label>
            <label><input type="radio" name="quiz_type" value="full" onchange="toggleFullMock()"> Full Mock (Multiple Sections)</label>
        </div>

        <div id="topic-upload" style="display: block;">
            <!-- Accept both .txt and .html/.htm -->
            <input type="file" id="topicFile" accept=".txt,.html,.htm">
        </div>

        <div id="full-upload" style="display: none;">
            <div id="fileGroups"></div>
            <button type="button" id="addSectionBtn">âž• Add Section</button>
        </div>

        <button id="uploadBtn">Upload & Parse</button>
        <div id="progress">Processing...</div>
    </div>

    <script>
        let sectionCount = 0;

        function toggleFullMock() {
            const type = document.querySelector('input[name="quiz_type"]:checked').value;
            document.getElementById('topic-upload').style.display = type === 'topic' ? 'block' : 'none';
            document.getElementById('full-upload').style.display = type === 'full' ? 'block' : 'none';
            if (type === 'full' && sectionCount === 0) {
                addFileGroup();
            }
        }

        function addFileGroup() {
            const container = document.getElementById('fileGroups');
            const group = document.createElement('div');
            group.className = 'file-group';
            group.id = `group-${sectionCount}`;
            group.innerHTML = `
                <input type="text" placeholder="Section Name (e.g., English)" id="section-${sectionCount}" required>
                <!-- Accept both .txt and .html/.htm -->
                <input type="file" accept=".txt,.html,.htm" id="file-${sectionCount}" required>
                <button type="button" class="remove-btn" onclick="removeFileGroup(${sectionCount})">Remove</button>
            `;
            container.appendChild(group);
            sectionCount++;
        }

        function removeFileGroup(id) {
            const group = document.getElementById(`group-${id}`);
            if (group) group.remove();
        }

        document.getElementById('addSectionBtn').addEventListener('click', addFileGroup);

        document.getElementById('uploadBtn').addEventListener('click', async () => {
            const quizType = document.querySelector('input[name="quiz_type"]:checked').value;
            const formData = new FormData();
            formData.append('quiz_type', quizType);

            if (quizType === 'topic') {
                const file = document.getElementById('topicFile').files[0];
                if (!file) { alert('Select a file'); return; }
                formData.append('file', file);
            } else {
                const groups = document.querySelectorAll('.file-group');
                if (groups.length === 0) { alert('Add at least one section'); return; }
                let valid = true;
                groups.forEach((group, idx) => {
                    const sectionInput = group.querySelector('input[type="text"]');
                    const fileInput = group.querySelector('input[type="file"]');
                    if (!sectionInput.value.trim()) {
                        alert(`Section name missing for group ${idx+1}`);
                        valid = false;
                        return;
                    }
                    if (!fileInput.files[0]) {
                        alert(`File missing for group ${idx+1}`);
                        valid = false;
                        return;
                    }
                    formData.append(`section_${idx}`, sectionInput.value.trim());
                    formData.append(`file_${idx}`, fileInput.files[0]);
                });
                if (!valid) return;
            }

            document.getElementById('progress').style.display = 'block';
            try {
                const res = await fetch('/upload', { method: 'POST', body: formData });
                const data = await res.json();
                if (data.error) {
                    alert('Error: ' + data.error);
                    document.getElementById('progress').style.display = 'none';
                } else {
                    window.location.href = `/preview/${data.quiz_id}`;
                }
            } catch (e) {
                alert('Upload failed');
                document.getElementById('progress').style.display = 'none';
            }
        });
    </script>
</body>
</html>
